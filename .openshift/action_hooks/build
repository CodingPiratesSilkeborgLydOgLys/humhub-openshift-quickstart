#!/bin/bash
# Reference: 
# https://www.humhub.org/docs/guide-admin-installation.html
# https://developers.openshift.com/managing-your-applications/environment-variables.html
# https://getcomposer.org/download/
# https://getcomposer.org/doc/00-intro.md#locally

echo "get some info"
pwd
ls -R
env
which composer

echo "retrieving humhub stable"
cd  ${OPENSHIFT_REPO_DIR}
pwd
wget --quiet https://github.com/humhub/humhub/archive/stable.zip
unzip -q stable.zip

#echo "get composer"
#cd  ${OPENSHIFT_REPO_DIR}
#mkdir composer

#php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
#php -r "if (hash_file('SHA384', 'composer-setup.php') === '55d6ead61b29c7bdee5cccfb50076874187bd9f21f65d8991d46ec5cc90518f447387fb9f76ebae1fbbacf329e583e30') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
#php composer-setup.php --install-dir=${OPENSHIFT_REPO_DIR}composer
#php -r "unlink('composer-setup.php');"

echo "composer self-update"
${OPENSHIFT_HOMEDIR}php/usr/bin/composer self-update

echo "fetch dependancies"
composer global require "fxp/composer-asset-plugin:~1.1.1"
composer update

echo "writable by the webserver TODO:check 777 ok"
chmod 777 ${OPENSHIFT_REPO_DIR}humhub-stable/assets
chmod 777 ${OPENSHIFT_REPO_DIR}humhub-stable/protected/config
chmod 777 ${OPENSHIFT_REPO_DIR}humhub-stable/protected/modules
chmod 777 ${OPENSHIFT_REPO_DIR}humhub-stable/protected/runtime
chmod 777 ${OPENSHIFT_REPO_DIR}humhub-stable/uploads

echo "executable"
chmod ugo+x ${OPENSHIFT_REPO_DIR}humhub-stable/protected/yii
chmod ugo+x ${OPENSHIFT_REPO_DIR}humhub-stable/protected/yii.bat

echo "do not allow accessable by webserver: TODO: check that .htaccess is correct"
echo protected
echo uploads/file